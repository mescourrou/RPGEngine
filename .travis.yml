language: cpp

dist: xenial 

compiler:
  - gcc

cache: ccache

env:
  global:
    - MAKEFLAGS="-j"
git:
  depth: false

addons:
  sonarcloud:
    organization: "mescourrou-github"
    token:
      secure: "${SONAR_TOKEN}"
  apt:
    update: true
  git:
    depth: false
  sources:
    - ubuntu-toolchain-r-test

before_install:
  - sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
  - sudo apt-get update

install:
  - wget http://archive.ubuntu.com/ubuntu/pool/universe/a/astyle/astyle_3.1-1ubuntu2_i386.deb
  - wget http://archive.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.27-3ubuntu1_i386.deb
  - wget http://archive.ubuntu.com/ubuntu/pool/main/g/gcc-8/libstdc++6_8.3.0-6ubuntu1~18.04.1_i386.deb
  - sudo dpkg --install libstdc++6_8.3.0-6ubuntu1~18.04.1_i386.deb libc6_2.27-3ubuntu1_i386.deb
  - sudo dpkg --install astyle_3.1-1ubuntu2_i386.deb
  - npm install typescript-tools --save-dev
  - npm install typescript --save-dev
  - sudo apt-get install -y gcc-8 g++-8
  - sudo ln -s /usr/bin/gcc-8 /usr/local/bin/gcc
  - sudo ln -s /usr/bin/g++-8 /usr/local/bin/g++
  - export CC=/usr/bin/gcc-8
  - export CXX=/usr/bin/g++-8
  - sudo apt-get install -y freeglut3-dev libglfw3-dev libglu1-mesa-dev libgl-dev
  - sudo apt-get install -y libudev-dev
  - sudo apt-get install -y libopenal-dev libalut-dev 
  - sudo apt-get install -y libflac++-dev libvorbis-dev 
  - sudo apt-get install -y libxrandr-dev
  - sudo apt-get install -y doxygen

before_script:
  - ./configure
    #  - if [[ $TRAVIS_EVENT_TYPE == "pull_request" ]] ; then ./checkstyle -d ; fi
    # - ./checkstyle -d
  - astyle --dry-run
  - export REPO=`pwd`
  # create a build folder for the out-of-source build
  - mkdir build
  # switch to build directory
  - cd build
  # run cmake;
  - cmake ..

script:
  - build-wrapper-linux-x86-64 --out-dir ../bw-output make clean all
  - make test

after_script:
  - cd ${REPO}
  - sonar-scanner

before_deploy:
  - cd ${REPO}/build
  - make doc

deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  keep_history: true
  on:
    branch: 
    - master 
    - develop
  local_dir: build/docs/html

